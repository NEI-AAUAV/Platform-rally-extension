name: E2E Tests (Playwright)

permissions:
  contents: read

on:
  push:
    branches: [ main ]
    paths:
      - 'web-rally/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'web-rally/**'
  workflow_dispatch:

jobs:
  e2e-tests:
    name: Playwright E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'
      
      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: latest
          virtualenvs-create: true
          virtualenvs-in-project: true
      
      - name: Install API dependencies
        working-directory: api-rally
        run: poetry install --no-interaction --no-root
      
      - name: Generate OpenAPI schema
        working-directory: api-rally
        run: |
          poetry run python - << 'PY'
          from app.main import app
          from fastapi.openapi.utils import get_openapi
          import json, os
          
          schema = get_openapi(
              title=getattr(app, 'title', 'API'),
              version=getattr(app, 'version', '0.0.0'),
              routes=app.routes,
          )
          
          # Use os.getcwd() since __file__ is undefined when executing via stdin
          # Since working-directory is api-rally, we need to go up one level to repo root
          repo_root = os.path.dirname(os.getcwd())
          out_path = os.path.join(repo_root, 'web-rally', 'openapi.json')
          with open(out_path, 'w') as f:
              json.dump(schema, f)
          print(f"Wrote schema to {out_path}")
          PY
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
      
      - name: Set up pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9
      
      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV
      
      - name: Cache pnpm dependencies
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-e2e-${{ hashFiles('web-rally/pnpm-lock.yaml') }}                                                                               
          restore-keys: ${{ runner.os }}-pnpm-e2e-
      
      - name: Install dependencies
        working-directory: web-rally
        run: pnpm install --frozen-lockfile
      
      - name: Generate API client
        working-directory: web-rally
        run: pnpm run generate-client
      
      - name: Build web-rally
        working-directory: web-rally
        env:
          GENERATE_SOURCEMAP: false
        run: pnpm build
      
      - name: Install Playwright browsers
        working-directory: web-rally
        run: pnpm exec playwright install --with-deps chromium
      
      - name: Run Playwright E2E tests
        working-directory: web-rally
        run: pnpm run test:e2e
        env:
          CI: true
      
      - name: Upload Playwright test results
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: playwright-report
          path: web-rally/playwright-report/
          retention-days: 7
      
      - name: Upload Playwright test videos
        uses: actions/upload-artifact@v5
        if: failure()
        with:
          name: playwright-videos
          path: web-rally/test-results/
          retention-days: 7
      
      - name: Upload Playwright screenshots
        uses: actions/upload-artifact@v5
        if: failure()
        with:
          name: playwright-screenshots
          path: web-rally/test-results/
          retention-days: 7

