name: Docker Build Validation

on:
  push:
    branches: [ main ]
    paths:
      - 'api-rally/Dockerfile*'
      - 'web-rally/Dockerfile*'
      - 'api-rally/pyproject.toml'
      - 'api-rally/poetry.lock'
      - 'web-rally/package.json'
      - 'web-rally/pnpm-lock.yaml'
  pull_request:
    branches: [ main ]
    paths:
      - 'api-rally/Dockerfile*'
      - 'web-rally/Dockerfile*'
  workflow_dispatch:

jobs:
  build-api-docker:
    name: Build API Docker Image
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build API development image
        uses: docker/build-push-action@v5
        with:
          context: ./api-rally
          file: ./api-rally/Dockerfile
          push: false
          load: true
          tags: rally-api:dev
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Build API production image
        uses: docker/build-push-action@v5
        with:
          context: ./api-rally
          file: ./api-rally/Dockerfile.prod
          push: false
          tags: rally-api:prod
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Smoke-test API image
        run: |
          echo "üîé Running lightweight smoke test (compile Python sources)..."
          docker run --rm rally-api:dev poetry run python -m compileall app
          echo "‚úÖ API image passed smoke test"

  build-web-docker:
    name: Build Web Docker Image
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build web development image
        uses: docker/build-push-action@v5
        with:
          context: ./web-rally
          file: ./web-rally/Dockerfile
          push: false
          load: true
          tags: rally-web:dev
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Build web production image
        uses: docker/build-push-action@v5
        with:
          # Context must be repo root for multi-stage build
          # (Stage 1 needs api-rally/ to generate OpenAPI schema)
          context: .
          file: ./web-rally/Dockerfile.prod
          push: false
          tags: rally-web:prod
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Test web container responds
        run: |
          echo "üöÄ Starting web dev container..."
          docker run --rm -d --name rally-web-test -p 3003:3003 rally-web:dev
          
          echo "‚è≥ Waiting for Vite dev server to start..."
          sleep 20
          
          echo "üîç Testing if server responds..."
          if curl -f http://localhost:3003 --max-time 10; then
            echo "‚úÖ Web server is responding"
            docker stop rally-web-test
          else
            echo "‚ùå Web server not responding"
            echo "Container logs:"
            docker logs rally-web-test || true
            docker stop rally-web-test || true
            exit 1
          fi

  docker-compose-validation:
    name: Validate Docker Compose
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Validate compose.override.yml
        run: |
          if [ -f compose.override.yml ]; then
            echo "Validating compose.override.yml..."
            docker compose -f .github/compose.stub.yml -f compose.override.yml config > /dev/null
            echo "‚úÖ compose.override.yml is valid"
          else
            echo "‚ö†Ô∏è  compose.override.yml not found"
          fi
      
      - name: Validate compose.override.prod.yml
        run: |
          if [ -f compose.override.prod.yml ]; then
            echo "Validating compose.override.prod.yml..."
            docker compose -f .github/compose.stub.yml -f compose.override.prod.yml config > /dev/null
            echo "‚úÖ compose.override.prod.yml is valid"
          else
            echo "‚ö†Ô∏è  compose.override.prod.yml not found"
          fi
      
      - name: Check service names match manifest
        run: |
          MANIFEST_NAME=$(jq -r '.name' manifest.json)
          echo "Extension name from manifest: $MANIFEST_NAME"
          
          # Check if compose file uses correct service naming
          if grep -q "api_${MANIFEST_NAME}" compose.override.yml && \
             grep -q "web_${MANIFEST_NAME}" compose.override.yml; then
            echo "‚úÖ Service names match manifest"
          else
            echo "‚ö†Ô∏è  Service names may not match manifest naming convention"
          fi

