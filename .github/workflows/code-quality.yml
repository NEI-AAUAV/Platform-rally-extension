name: Code Quality

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  lint-python:
    name: Python Linting & Type Checking
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
      
      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: latest
          virtualenvs-create: true
          virtualenvs-in-project: true
      
      - name: Cache Python dependencies
        uses: actions/cache@v3
        with:
          path: api-rally/.venv
          key: venv-${{ runner.os }}-${{ hashFiles('api-rally/poetry.lock') }}
      
      - name: Install dependencies
        working-directory: api-rally
        run: poetry install --no-interaction --with dev
      
      - name: Run black (formatting check)
        working-directory: api-rally
        run: poetry run black --check app/
        continue-on-error: true
      
      - name: Run isort (import sorting check)
        working-directory: api-rally
        run: poetry run isort --check-only app/
        continue-on-error: true
      
      - name: Run flake8 (linting)
        working-directory: api-rally
        run: poetry run flake8 app/
        continue-on-error: true
      
      - name: Run mypy (type checking) - BLOCKING
        working-directory: api-rally
        run: poetry run mypy app/
        # Removed continue-on-error: true - this is now a blocking check
      
      - name: Summary
        if: always()
        run: |
          echo "✅ Code quality checks completed"
          echo "⚠️  Formatting and linting warnings don't fail the build"
          echo "❌ Type checking (mypy) failures will block the build"

  lint-typescript:
    name: TypeScript Linting & Type Checking
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
      
      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: latest
          virtualenvs-create: true
          virtualenvs-in-project: true
      
      - name: Install API dependencies
        working-directory: api-rally
        run: poetry install --no-interaction --no-root
      
      - name: Generate OpenAPI schema
        working-directory: api-rally
        run: |
          poetry run python - << 'PY'
          from app.main import app
          from fastapi.openapi.utils import get_openapi
          import json, os
          
          schema = get_openapi(
              title=getattr(app, 'title', 'API'),
              version=getattr(app, 'version', '0.0.0'),
              routes=app.routes,
          )
          
          # Use os.getcwd() since __file__ is undefined when executing via stdin
          base_dir = os.getcwd()
          out_path = os.path.join(base_dir, 'web-rally', 'openapi.json')                                                                 
          with open(out_path, 'w') as f:
              json.dump(schema, f)
          print(f"Wrote schema to {out_path}")
          PY
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Set up pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9
      
      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV
      
      - name: Cache pnpm dependencies
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-${{ hashFiles('web-rally/pnpm-lock.yaml') }}
          restore-keys: ${{ runner.os }}-pnpm-
      
      - name: Install dependencies
        working-directory: web-rally
        run: pnpm install --frozen-lockfile
      
      - name: Generate API client
        working-directory: web-rally
        run: pnpm run generate-client
      
      - name: Run ESLint
        working-directory: web-rally
        run: pnpm run lint || true
        continue-on-error: true
      
      - name: Run TypeScript type checking - BLOCKING
        working-directory: web-rally
        run: pnpm run type-check || pnpm exec tsc --noEmit
        # Removed continue-on-error: true - this is now a blocking check
      
      - name: Check formatting with Prettier
        working-directory: web-rally
        run: pnpm exec prettier --check "src/**/*.{ts,tsx,js,jsx,json,css}" || true
        continue-on-error: true
      
      - name: Summary
        if: always()
        run: |
          echo "✅ TypeScript quality checks completed"
          echo "⚠️  Formatting and linting warnings don't fail the build"
          echo "❌ Type checking failures will block the build"

  security-scan:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
      
      - name: Install Poetry
        uses: snok/install-poetry@v1
      
      - name: Check Python dependencies for vulnerabilities
        working-directory: api-rally
        run: |
          poetry install --no-interaction
          poetry run pip install safety || pip install safety
          poetry run safety check --json || echo "⚠️  Security issues found in Python dependencies"
        continue-on-error: true
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Check npm dependencies for vulnerabilities
        working-directory: web-rally
        run: |
          npm audit --audit-level=moderate || echo "⚠️  Security issues found in npm dependencies"
        continue-on-error: true
      
      - name: Summary
        run: |
          echo "✅ Security scan completed"
          echo "Review dependency vulnerabilities and update packages as needed"

